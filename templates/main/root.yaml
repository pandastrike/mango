# This is a templatized verion of a CFo template for Amazon API Gateway with
# Lambda backends as the handlers.  This template forms the core of every
# Panda Sky app deployment, with mixins adding resources to the description.

AWSTemplateFormatVersion: "2010-09-09"
Description: "{{env}} {{name}} - deployed by Panda Sky"
Resources:
  {{#if aws.vpc.new}}
  SkyCoreVPC:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      Tags:
        - Key: Substack Type
          Value: Core VPC
        {{#each tags}}
        - Key: {{Key}}
          Value: {{Value}}
        {{/each}}
      TemplateURL: "https://{{environmentVariables.skyBucket}}.s3.amazonaws.com/templates/core/vpc.yaml"
  {{/if}}

  SkyCore:
    Type: "AWS::CloudFormation::Stack"
    {{#if aws.vpc.new}}
    DependsOn:
      - SkyCoreVPC
    {{/if}}
    Properties:
      {{#with aws.vpc}}
      {{#if new}}
      Parameters:
        SecurityGroups:
          "Fn::GetAtt": ["SkyCoreVPC", "Outputs.SecurityGroups"]
        Subnets:
          "Fn::GetAtt": ["SkyCoreVPC", "Outputs.Subnets"]
      {{/if}}
      {{#unless new}}
      Parameters:
        SecurityGroups: {{securityGroups}}
        Subnets: {{subnets}}
      {{/unless}}
      {{/with}}
      Tags:
        - Key: Substack Type
          Value: Core
        {{#each tags}}
        - Key: {{Key}}
          Value: {{Value}}
        {{/each}}
      TemplateURL: "https://{{environmentVariables.skyBucket}}.s3.amazonaws.com/templates/core/index.yaml"

  {{#if needsMixinResources}}
  SkyMixins:
    Type: "AWS::CloudFormation::Stack"
    {{#if aws.vpc.new}}
    DependsOn:
      - SkyCore
    {{/if}}
    Properties:
      Parameters:
        LambdaRole:
          "Fn::GetAtt": [SkyCore, "Outputs.LambdaRole"]
      {{#with aws.vpc}}
      {{#if new}}
        VPC:
          "Fn::GetAtt": ["SkyCoreVPC", "Outputs.VPC"]
        AvailabilityZones:
          "Fn::GetAtt": ["SkyCoreVPC", "Outputs.AvailabilityZones"]
        SecurityGroups:
          "Fn::GetAtt": ["SkyCoreVPC", "Outputs.SecurityGroups"]
        Subnets:
          "Fn::GetAtt": ["SkyCoreVPC", "Outputs.Subnets"]
        RouteTables:
          "Fn::GetAtt": ["SkyCoreVPC", "Outputs.RouteTables"]
      {{/if}}
      {{#unless new}}
        VPC: {{vpcID}}
        AvailabilityZones: {{availabilityZones}}
        SecurityGroups: {{securityGroups}}
        Subnets: {{subnets}}
        RouteTables: {{routeTables}}
      {{/unless}}
      {{/with}}
      Tags:
        - Key: Substack Type
          Value: Mixins Top Level
        {{#each tags}}
        - Key: {{Key}}
          Value: {{Value}}
        {{/each}}
      TemplateURL: "https://{{environmentVariables.skyBucket}}.s3.amazonaws.com/templates/mixins/index.yaml"
  {{/if}}

Outputs:
  API:
    Value:
      "Fn::GetAtt": ["SkyCore", "Outputs.API"]
  {{#with aws.vpc}}
  {{#if new}}
  VPC:
    Value:
      "Fn::GetAtt": ["SkyCoreVPC", "Outputs.VPC"]
  AvailabilityZones:
    Value:
      "Fn::GetAtt": ["SkyCoreVPC", "Outputs.AvailabilityZones"]
  SecurityGroups:
    Value:
      "Fn::GetAtt": ["SkyCoreVPC", "Outputs.SecurityGroups"]
  Subnets:
    Value:
      "Fn::GetAtt": ["SkyCoreVPC", "Outputs.Subnets"]
  {{/if}}
  {{#unless new}}
  VPC:
    Value: {{vpcID}}
  AvailabilityZones:
    Value: {{availabilityZones}}
  SecurityGroups:
    Value: {{securityGroups}}
  Subnets:
    Value: {{subnets}}
  {{/unless}}
  {{/with}}
