{{gateway.name}}:
  {{#unless resource.rootResource}}
  {{#if dependencies}}
  DependsOn:
    {{#each dependencies}}
    - {{this}}
    {{/each}}
  {{/if}}
  {{/unless}}
  Type: "AWS::ApiGateway::Method"
  Properties:
    RestApiId:
      Ref: API
    ResourceId:
      {{resource.gateway.resourceID}}
    AuthorizationType: NONE
    HttpMethod: {{name}}
    {{#if requestModel}}
    RequestModels:
      "application/json": {{requestModel}}
    {{/if}}
    {{#if parameters}}
    RequestParameters:
    {{#each parameters}}
    {{#if path}}
      "method.request.path.{{name}}": true
    {{else}}
      "method.request.querystring.{{name}}": true
    {{/if}}
    {{/each}}
    {{/if}}
    Integration:
      Type: AWS
      IntegrationHttpMethod: POST
      {{#unless parameters}}
      PassthroughBehavior: WHEN_NO_TEMPLATES
      {{/unless}}
      Uri:
        "Fn::Join":
          - ""
          -
            - "arn:aws:apigateway:"
            - {"Ref": "AWS::Region"}
            - ":lambda:path/2015-03-31/functions/"
            - {"Fn::GetAtt": [{{lambda.handler.name}}, "Arn"]}
            - "/invocations"
      RequestTemplates:
        "application/json": >
          {
            "url": {
              "path": {
                #foreach($param in $input.params().path.keySet())
                "$param": "$util.escapeJavaScript($input.params().path.get($param))"
                #if($foreach.hasNext),#end
                #end
              },
              "query": {
                #foreach($param in $input.params().querystring.keySet())
                "$param": "$util.escapeJavaScript($input.params().querystring.get($param))"
                #if($foreach.hasNext),#end
                #end
              }
            },
            "method": "$context.httpMethod",
            "headers": {
              #foreach($param in $input.params().header.keySet())
              "$param": "$util.escapeJavaScript($input.params().header.get($param))"
              #if($foreach.hasNext),#end
              #end
            },
            "content" : $input.json('$')
          }



      IntegrationResponses:
      {{#each IntegrationResponses}}
        - StatusCode: {{StatusCode}}
        {{#if SelectionPattern}}
          SelectionPattern: {{SelectionPattern}}
        {{/if}}
          ResponseParameters:
          {{#eachProperty headers}}
            method.response.header.{{key}}: "{{value}}"
          {{/eachProperty}}

        {{#if ResponseTemplates}}
          ResponseTemplates:
          {{#eachProperty ResponseTemplates}}
            {{key}}: "{{value}}"
          {{/eachProperty}}
        {{/if}}

      {{/each}}

    MethodResponses:
    {{#each MethodResponses}}
      - StatusCode: {{StatusCode}}
        ResponseParameters:
        {{#eachProperty headers}}
          method.response.header.{{key}}: {{value}}
        {{/eachProperty}}
    {{/each}}

{{#with lambda}}
{{handler.name}}:
  Type: "AWS::Lambda::Function"
  Properties:
    Description: "Handler for API {{@root.name}}"
    FunctionName: {{function.name}}

    Handler: "lib/sky.API"
    Role:
      "Fn::GetAtt" : ["{{@root.roleName}}", "Arn"]
    Runtime: {{@root.aws.runtime}}
    Environment:
      Variables:
      {{#eachProperty @root.environmentVariables}}
        {{key}}: {{value}}
      {{/eachProperty}}
  {{#if timeout}}
    Timeout: {{timeout}}
  {{else}}
    Timeout: 15
  {{/if}}
    Code:
      S3Bucket: {{handler.bucket}}
      S3Key: "package.zip"

{{permission.name}}:
  Type: "AWS::Lambda::Permission"
  Properties:
    Action: "lambda:InvokeFunction"
    FunctionName:
      "Fn::GetAtt": [{{handler.name}}, "Arn"]
    Principal: apigateway.amazonaws.com
    SourceArn:
      "Fn::Join":
        - ""
        -
          - "arn:aws:execute-api:"
          - {"Ref": "AWS::Region"}
          - ":"
          - {"Ref": "AWS::AccountId"}
          - ":"
          - {"Ref": "API"}
          - {{permission.path}}
{{/with}} # lambda
